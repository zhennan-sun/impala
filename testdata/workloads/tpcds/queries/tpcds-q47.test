====
---- QUERY: TPCDS-Q47
with v1 as (
 select i_category, i_brand,
        s_store_name, s_company_name,
        d_year, d_moy,
        sum(ss_sales_price) sum_sales,
        avg(sum(ss_sales_price)) over
          (partition by i_category, i_brand,
                     s_store_name, s_company_name, d_year)
          avg_monthly_sales,
        rank() over
          (partition by i_category, i_brand,
                     s_store_name, s_company_name
           order by d_year, d_moy) rn
 from item, store_sales, date_dim, store
 where ss_item_sk = i_item_sk and
       ss_sold_date_sk = d_date_sk and
       ss_store_sk = s_store_sk and
       (
         d_year = 2000 or
         ( d_year = 2000-1 and d_moy =12) or
         ( d_year = 2000+1 and d_moy =1)
       )
 group by i_category, i_brand,
          s_store_name, s_company_name,
          d_year, d_moy),
 v2 as(
 select v1.i_category, v1.i_brand
        ,v1.d_year
        ,v1.avg_monthly_sales
        ,v1.sum_sales, v1_lag.sum_sales psum, v1_lead.sum_sales nsum
 from v1, v1 v1_lag, v1 v1_lead
 where v1.i_category = v1_lag.i_category and
       v1.i_category = v1_lead.i_category and
       v1.i_brand = v1_lag.i_brand and
       v1.i_brand = v1_lead.i_brand and
       v1.s_store_name = v1_lag.s_store_name and
       v1.s_store_name = v1_lead.s_store_name and
       v1.s_company_name = v1_lag.s_company_name and
       v1.s_company_name = v1_lead.s_company_name and
       v1.rn = v1_lag.rn + 1 and
       v1.rn = v1_lead.rn - 1)
 select * from ( select  *
 from v2
 where  d_year = 2000 and
        avg_monthly_sales > 0 and
        case when avg_monthly_sales > 0 then abs(sum_sales - avg_monthly_sales) / avg_monthly_sales else null end > 0.1
 order by sum_sales - avg_monthly_sales, d_year
 limit 100
 ) as v3;
---- RESULTS
'Music','exportischolar #2',2000,361.1950007999937,13.03999996185303,106.7700011730194,409.2999934256077
'Children','edu packexporti #2',2000,362.0491653059919,16.51000013947487,244.8100008964539,332.6999956965446
'Children','amalgexporti #2',2000,359.2541688134273,17.79999923706055,119.7899990081787,402.0399971008301
'Men','exportiimporto #2',2000,360.2924974138538,24.06999909877777,146.1599996089935,311.1099967956543
'Shoes','edu packedu pack #2',2000,435.2381834496151,99.52000117301941,117.6100025177002,342.7600073814392
'Shoes','edu packedu pack #2',2000,367.2590905590491,33.69000053405762,183.5200008749962,248.8300000429153
'Music','importoscholar #2',2000,356.1416670084,25.73000001907349,467.1599864959717,446.3399982452393
'Music','importoscholar #2',2000,349.9766662269831,21.94000005722046,158.7499995231628,189.8599987030029
'Women','importoamalg #2',2000,339.1266653848191,13.02000045776367,362.7699999809265,64.19000244140625
'Music','exportischolar #2',2000,395.42250046134,70.0600004196167,176.3600010871887,100.9599962234497
'Shoes','amalgedu pack #2',2000,373.1616667894025,49.95000171661377,506.8500022888184,391.3499984741211
'Children','amalgexporti #2',2000,359.2541688134273,37.88000011444092,385.0299953222275,162.1000003814697
'Children','edu packexporti #2',2000,370.889163856705,49.91999936103821,572.4999887943268,170.6800022125244
'Men','importoimporto #2',2000,386.1574978902936,67.23000037670135,219.8599932193756,262.5699981153011
'Shoes','edu packedu pack #2',2000,435.2381834496151,117.6100025177002,240.8199973106384,99.52000117301941
'Music','exportischolar #2',2000,361.1950007999937,46.12000107765198,409.2999934256077,265.879994392395
'Children','amalgexporti #2',2000,359.2541688134273,44.62000077962875,402.0399971008301,579.2700080871582
'Shoes','amalgedu pack #2',2000,381.9016673173755,71.30000305175781,153.6899967193604,174.6900022923946
'Shoes','edu packedu pack #2',2000,347.34833274285,38.60999965667725,100.060002207756,583.7499899864197
'Children','importoexporti #2',2000,329.8899995237589,25.03999996185303,175.2000041007996,331.6299922466278
'Shoes','importoedu pack #2',2000,324.1790896491571,22.88999938964844,207.7099990844727,293.5699923038483
'Shoes','edu packedu pack #2',2000,435.2381834496151,134.1500000953674,348.9499931335449,240.8199973106384
'Children','importoexporti #2',2000,302.2383334736029,2.180000066757202,399.8300030231476,387.3300023078918
'Children','importoexporti #2',2000,329.8899995237589,33.47000002861023,192.6399965286255,241.8399991989136
'Shoes','importoedu pack #2',2000,377.7558316141367,81.51999950408936,162.1800026893616,261.9699932336807
'Music','exportischolar #2',2000,369.7908335415025,74.37999844551086,89.30999946594238,558.7699987888336
'Music','exportischolar #2',2000,395.42250046134,100.9599962234497,70.0600004196167,314.9400033950806
'Women','amalgamalg #2',2000,336.939998739145,43.31000082194805,171.6099996566772,308.0699892044067
'Shoes','exportiedu pack #2',2000,297.0300013609231,5.409999847412109,136.960005030036,163.2800025939941
'Music','exportischolar #2',2000,395.42250046134,103.9799976348877,209.3499985933304,735.0799965858459
'Men','exportiimporto #2',2000,297.0808323025703,8.539999961853027,164.7600024938583,440.1899899244308
'Women','edu packamalg #2',2000,297.4866681993008,9.180000305175781,86.30000066757202,205.519998550415
'Music','importoscholar #2',2000,356.1416670084,68.52999877929688,731.6700038909912,467.1599864959717
'Music','importoscholar #2',2000,354.3372730856592,66.79000267386436,540.5600023269653,337.6200051307678
'Women','edu packamalg #2',2000,387.2424998593827,101.4199991226196,312.6700057685375,319.7300035953522
'Men','importoimporto #2',2000,295.6916666924953,10.42000007629395,147.5600032806396,208.5100011825562
'Men','importoimporto #2',2000,299.572500264893,14.42999982833862,122.9800024032593,189.7299976348877
'Shoes','importoedu pack #2',2000,324.1790896491571,39.68000057339668,293.5699923038483,282.1300027370453
'Women','edu packamalg #2',2000,387.2424998593827,102.8799991607666,238.969998717308,312.6700057685375
'Men','importoimporto #2',2000,284.224167401592,1.159999966621399,235.459997177124,195.9100027084351
'Music','importoscholar #2',2000,350.9441683938106,67.9799976348877,177.6999950408936,180.4199979901314
'Music','exportischolar #2',2000,369.7908335415025,89.30999946594238,458.5999934673309,74.37999844551086
'Men','edu packimporto #2',2000,311.3033323287964,31.69999885559082,241.10999584198,63.42000007629395
'Women','importoamalg #2',2000,297.1691661526759,18.01999974250793,300.5899943113327,51.18000030517578
'Shoes','importoedu pack #2',2000,354.3716667294502,75.2400016784668,362.6899982094765,186.6299953460693
'Music','edu packscholar #2',2000,305.2008328984181,28.37999963760376,77.10999989509583,147.9600028991699
'Children','edu packexporti #2',2000,351.0500010748704,76.00999975204468,180.5199947357178,141.7500028610229
'Women','importoamalg #2',2000,339.1266653848191,64.19000244140625,13.02000045776367,254.3899927139282
'Men','exportiimporto #2',2000,297.0808323025703,24.11000061035156,242.7599954605103,248.5799980163574
'Women','edu packamalg #2',2000,288.1266652299091,16.55000019073486,274.4299960136414,347.5300065279007
'Music','importoscholar #2',2000,354.3372730856592,84.08000069856644,114.5700010061264,183.0799989700317
'Children','importoexporti #2',2000,359.2683348407348,90.06000185012817,209.9900054931641,127.8400049209595
'Music','edu packscholar #2',2000,357.1316664020221,88.56000280380249,219.3800058364868,126.2799987792969
'Women','edu packamalg #2',2000,309.3433323887487,41.32999897003174,236.3000001907349,86.67999744415283
'Women','edu packamalg #2',2000,387.2424998593827,120.029997587204,164.1500034332275,315.3500028848648
'Women','amalgamalg #2',2000,336.939998739145,72.41999912261963,308.0699892044067,212.6700007915497
'Music','edu packscholar #2',2000,303.1766666720311,38.66000089049339,174.7899985313416,40.61000061035156
'Children','exportiexporti #2',2000,269.2383319487174,4.78000020980835,164.1500018835068,361.8699998855591
'Women','amalgamalg #2',2000,288.2983328091602,24.71999931335449,92.24000072479248,38.34999942779541
'Children','importoexporti #2',2000,296.5150003712624,33.43999862670898,338.989999294281,305.2100045681
'Women','edu packamalg #2',2000,321.6033345212539,58.71000003814697,246.9299967288971,111.439998626709
'Music','edu packscholar #2',2000,303.1766666720311,40.61000061035156,38.66000089049339,381.5900032520294
'Shoes','importoedu pack #2',2000,303.6050004561742,41.77000045776367,476.5499978624284,152.5500016212463
'Shoes','amalgedu pack #2',2000,262.9125007390976,1.759999990463257,199.7099990844727,232.0400004386902
'Women','exportiamalg #2',2000,312.0883330777287,52.16999995708466,181.7899976670742,604.0700104236603
'Men','importoimporto #1',2000,264.9275004913409,6.09000027179718,51.7400016784668,324.7099990844727
'Men','importoimporto #2',2000,299.6108322702348,42.72999954223633,312.1999988555908,302.0299970656633
'Music','edu packscholar #2',2000,364.7741667032242,108.7500019073486,264.0799994468689,233.0899987220764
'Shoes','edu packedu pack #2',2000,356.7216673245032,100.8700029850006,404.1200022697449,151.6800003051758
'Men','edu packimporto #2',2000,260.3249996503194,4.820000171661377,153.0700016021729,52.59000015258789
'Men','importoimporto #2',2000,299.572500264893,44.47999858856201,186.439998626709,115.4400002509356
'Music','exportischolar #2',2000,361.1950007999937,106.7700011730194,586.3700032234192,13.03999996185303
'Women','edu packamalg #2',2000,297.4866681993008,44.56999921798706,110.270001411438,86.30000066757202
'Shoes','exportiedu pack #2',2000,257.6558327538272,5.059999942779541,179.2499952316284,171.3400032520294
'Men','edu packimporto #2',2000,260.3249996503194,8.010000228881836,392.0500040054321,153.0700016021729
'Men','exportiimporto #2',2000,276.3174994836251,24.40000057220459,175.4400024414062,121.2100033760071
'Men','edu packimporto #2',2000,259.7783322731654,7.96999979019165,361.6900033950806,271.3000040054321
'Music','exportischolar #1',2000,265.8549980521202,14.47000026702881,111.7999997138977,143.6900005340576
'Children','importoexporti #2',2000,296.5150003712624,45.29999971389771,305.2100045681,509.3600069284439
'Women','amalgamalg #2',2000,288.2983328091602,38.34999942779541,24.71999931335449,167.1200037002563
'Children','amalgexporti #2',2000,258.1958345721166,8.510000228881836,284.6200013160706,174.9299988746643
'Men','amalgimporto #2',2000,269.1991674592718,19.52000045776367,283.800001502037,149.6399993896484
'Men','exportiimporto #2',2000,263.886667534709,14.25,144.0400025844574,79.17999792098999
'Women','importoamalg #2',2000,297.1691661526759,48.06000113487244,51.18000030517578,161.1000022888184
'Children','edu packexporti #2',2000,351.0500010748704,102.5100030899048,141.7500028610229,329.3800058364868
'Shoes','exportiedu pack #2',2000,257.6558327538272,9.159999847412109,122.1999982148409,172.6299985647202
'Men','edu packimporto #2',2000,311.3033323287964,63.42000007629395,31.69999885559082,250.4399979114532
'Women','amalgamalg #2',2000,296.2083331122994,48.54000091552734,300.1899948120117,68.94999694824219
'Shoes','edu packedu pack #2',2000,347.34833274285,100.060002207756,114.4499998092651,38.60999965667725
'Women','importoamalg #2',2000,297.1691661526759,51.18000030517578,18.01999974250793,48.06000113487244
'Shoes','importoedu pack #2',2000,366.1045455986803,120.4799995422363,485.3899974822998,NULL
'Women','exportiamalg #2',2000,303.1675007989009,57.7199981212616,163.3499984741211,244.0900052785873
'Children','edu packexporti #2',2000,362.0491653059919,117.2000006437302,240.8800010681152,251.7699983119965
'Men','edu packimporto #2',2000,311.3033323287964,68.07000064849854,336.5299997329712,888.7699949741364
'Women','exportiamalg #2',2000,252.1641667336226,10.19999980926514,245.5099983215332,37.13999938964844
'Music','exportischolar #1',2000,268.6436344005845,27.04999923706055,362.7900009155273,162.2799987792969
'Shoes','edu packedu pack #2',2000,347.34833274285,106.809999704361,454.5400009155273,487.9299980401993
'Music','importoscholar #2',2000,354.3372730856592,114.5700010061264,171.2799978256226,84.08000069856644
'Children','amalgexporti #2',2000,250.3733324147761,10.75,210.5999994277954,63.72000205516815
'Men','importoimporto #2',2000,299.6108322702348,60.11000192165375,216.5099973678589,312.1999988555908
---- TYPES
STRING, STRING, INT, DOUBLE, DOUBLE, DOUBLE, DOUBLE
====